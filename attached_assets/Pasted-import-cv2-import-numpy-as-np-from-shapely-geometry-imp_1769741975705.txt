import cv2
import numpy as np
from shapely.geometry import Polygon
from shapely.validation import make_valid

def clean_almost_loops(contour, epsilon_factor=0.005):
    """
    Fixes 'almost loops' (hairpins/spikes) using approxPolyDP.
    
    Args:
        contour: The input OpenCV contour.
        epsilon_factor: Sensitivity (higher = more smoothing). 
                        0.005 is usually safe for logos.
    """
    # 1. ARC LENGTH: Get the perimeter of the contour
    peri = cv2.arcLength(contour, True)
    
    # 2. SIMPLIFY: approxPolyDP removes vertices that create 
    #    unnecessary complexity (like hairpins/spikes).
    #    epsilon is the max distance from the original curve.
    epsilon = epsilon_factor * peri
    approx = cv2.approxPolyDP(contour, epsilon, True)
    
    # 3. SAFETY CHECK: Ensure it's still a valid polygon using Shapely
    #    (This handles if the simplification accidentally created a real crossing)
    if len(approx) < 3:
        return [approx] # Return as is if too small
        
    poly = Polygon(approx.squeeze())
    
    # Clean invalid geometry if the simplification caused issues
    if not poly.is_valid:
        poly = make_valid(poly)
        
    # Convert back to OpenCV format
    fixed_contours = []
    if poly.geom_type == 'MultiPolygon':
        for geom in poly.geoms:
            coords = np.array(geom.exterior.coords).astype(np.int32)
            fixed_contours.append(coords.reshape(-1, 1, 2))
    elif poly.geom_type == 'Polygon':
        coords = np.array(poly.exterior.coords).astype(np.int32)
        fixed_contours.append(coords.reshape(-1, 1, 2))
        
    return fixed_contours

# --- EXAMPLE USAGE WITH YOUR "ALMOST LOOP" SCENARIO ---

# 1. Create a dummy "Hairpin" contour (A -> B -> A very close)
# This simulates a sharp spike that looks like a loop but isn't.
img = np.zeros((400, 400), dtype=np.uint8)
pts = np.array([
    [100, 100], 
    [300, 100], 
    [300, 102