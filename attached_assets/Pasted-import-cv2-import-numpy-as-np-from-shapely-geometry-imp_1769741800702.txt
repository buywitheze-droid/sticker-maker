import cv2
import numpy as np
from shapely.geometry import Polygon, MultiPolygon
from shapely.validation import make_valid

def fix_contour_loops(contour):
    """
    Fixes loops/self-intersections in a contour using Shapely.
    Returns a list of clean numpy arrays (contours).
    """
    # 1. Convert OpenCV contour (numpy array) to Shapely Polygon
    # Reshape is necessary because OpenCV contours are (N, 1, 2)
    squeeze_contour = contour.squeeze()
    
    # Handle cases where contour has too few points
    if len(squeeze_contour) < 3:
        return [contour]

    poly = Polygon(squeeze_contour)

    # 2. The Fix: use buffer(0) or make_valid() to resolve loops
    # buffer(0) is the classic trick to flatten self-intersections
    clean_poly = poly.buffer(0)
    
    # 3. Convert back to OpenCV format
    fixed_contours = []
    
    # The result might be a MultiPolygon if the loop split the shape in two
    if isinstance(clean_poly, MultiPolygon):
        for geom in clean_poly.geoms:
            # Extract exterior coordinates
            coords = np.array(geom.exterior.coords).astype(np.int32)
            # Reshape back to OpenCV format (N, 1, 2)
            fixed_contours.append(coords.reshape(-1, 1, 2))
    elif isinstance(clean_poly, Polygon):
        # Check if the polygon is empty (sometimes buffer(0) removes bad geometry entirely)
        if not clean_poly.is_empty:
            coords = np.array(clean_poly.exterior.coords).astype(np.int32)
            fixed_contours.append(coords.reshape(-1, 1, 2))

    return fixed_contours

# --- EXAMPLE USAGE ---

# 1. Create a dummy image with a self-intersecting "bowtie" shape
img = np.zeros((400, 400), dtype=np.uint8)
pts = np.array([[100, 100], [300, 300], [300, 100], [100, 300]], np.int32) # Bowtie shape
pts = pts.reshape((-1, 1, 2))
cv2.polylines(img, [pts], True, 255, 2)

# 2. Find the bad contour
contours, _ = cv2.findContours(img, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
bad_contour = contours[0]

print(f"Original contour points: {len(bad_contour)}")

# 3. Fix the loops
cleaned_contours = fix_contour_loops(bad_contour)

print(f"Fixed! Resulted in {len(cleaned_contours)} valid contour(s).")

# 4. (Optional) Visualize or save result
output_img = np.zeros_like(img)
cv2.drawContours(output_img, cleaned_contours, -1, 255, -1) # Fill the fixed shape
cv2.imwrite("fixed_contour_result.png", output_img)
print("Saved result to 'fixed_contour_result.png'")